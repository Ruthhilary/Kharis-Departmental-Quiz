<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kharis Department Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
<style>
* { box-sizing: border-box; margin:0; padding:0; transition: all 0.4s ease; }
body {
  font-family: 'Quicksand', sans-serif;
  background: var(--bg-img) center/cover no-repeat fixed;
  color: var(--text-color);
  display:flex; justify-content:center; align-items:center;
  min-height:100vh; padding:2rem;
}
:root {
  --bg-img: url('https://kharis.org/wp-content/uploads/2022/11/271239127_4868436629869265_1030465267411614205_n.jpg');
  --card-bg: rgba(60,19,97,0.85);
  --btn-bg: #ffd700;
  --btn-color: #3c1361;
  --text-color: #fff;
}
body.light {
  --card-bg: rgba(255,255,255,0.9);
  --btn-bg: #3c1361;
  --btn-color: #ffd700;
  --text-color: #000;
}
.container {
  max-width:700px; width:100%;
  background: var(--card-bg);
  border-radius: 20px; padding: 2rem 3rem; text-align:center;
  box-shadow:0 0 20px #8e24aaaa; display:flex; flex-direction:column;
  opacity:0; transform: translateY(30px);
}
.container.show { opacity:1; transform: translateY(0); }
h1 { font-family: 'Fredoka One', cursive; margin-bottom: 1.5rem; }
.question { font-family: 'Fredoka One', cursive; font-size:1.3rem; margin-bottom:1rem; }
.scripture { font-style: italic; font-size:0.95rem; margin-bottom:0.8rem; opacity:0.8; }
input[type="text"], select {
  padding: 14px; width: 90%; border-radius: 30px; border:none; font-size:1rem;
  margin-bottom: 1rem; text-align:center;
}
.btn {
  background: var(--btn-bg); color: var(--btn-color);
  border: none; padding: 1rem 2rem; margin: 0.5rem auto;
  border-radius: 50px; font-size: 1.1rem; cursor: pointer;
  font-family: 'Fredoka One', cursive;
  transition: background 0.3s, color 0.3s; width:90%;
}
.btn:hover { background: #6a1b9a; color: #ffd700; }
.back-btn {
  background: transparent; color: var(--btn-bg);
  border: 2px solid var(--btn-bg); padding: 0.6rem 1.4rem;
  border-radius: 30px; font-size: 1rem; cursor: pointer;
  font-family: 'Fredoka One', cursive; margin-top: 1rem;
}
.back-btn:hover { background: var(--btn-bg); color: var(--btn-color); }
.result { font-size:1.2rem; margin-top:1rem; }
.confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
.department { font-family: 'Fredoka One', cursive; font-size:1.3rem; margin:0.5rem 0; opacity:0; transition: opacity 0.8s ease; }
.department.show { opacity:1; }
.scripture-box {
  background: rgba(255, 215, 0, 0.15);
  color: var(--text-color);
  border-left: 5px solid var(--btn-bg);
  padding: 10px 15px;
  margin: 5px 0 15px 0;
  border-radius: 10px;
  font-style: italic;
  text-align: left;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 1s ease, transform 1s ease;
}
.scripture-box.show { opacity: 1; transform: translateY(0); }
.progress-bar {
  width: 100%; height: 12px; background: #ddd; border-radius: 20px; margin: 15px 0;
}
.progress { height: 100%; width: 0%; background: #ffd700; border-radius: 20px; transition: width 0.4s ease; }
.toggle-mode {
  position:absolute; top:15px; right:15px;
  background:transparent; border:2px solid var(--btn-bg);
  color:var(--btn-bg); padding:5px 12px; border-radius:20px;
  cursor:pointer; font-size:0.9rem;
}
.toggle-mode:hover { background: var(--btn-bg); color: var(--btn-color); }
@media(max-width:600px){
  .container { padding:1.5rem; }
  .btn { font-size:1rem; padding:0.8rem; }
}
</style>
</head>
<body>
<button class="toggle-mode" id="modeBtn">🌙</button>
<div class="container show">
  <div id="start-screen">
    <h1>Are You Ready to Discover Your Department?</h1>
    <input type="text" id="username" placeholder="Enter your name" />
    <input type="text" id="branch" placeholder="Enter your branch of Kharis Church" />
    <button class="btn" id="start-kharis">Kharis</button>
  </div>

  <div id="quiz" style="display:none;"></div>
  <div class="progress-bar"><div class="progress" id="progress"></div></div>
  <button class="back-btn" id="back-btn" style="display:none;">&larr; Back</button>
  <div id="result" style="display:none;"></div>
  <canvas id="confetti-canvas" class="confetti"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
(() => {
const quizEl = document.getElementById("quiz");
const startScreenEl = document.getElementById("start-screen");
const resultEl = document.getElementById("result");
const backBtn = document.getElementById("back-btn");
const progressEl = document.getElementById("progress");

let username="", branch="";
let currentQuiz = null;
let currentQ = 0;
let questionHistory = [];
let deptScores = {};
let traits = {creative:0, organised:0, bold:0, servant:0};
let answersGiven = [];

const SHEET_URL = "https://script.google.com/macros/s/AKfycbxz0F4EoHusuSJ_e04shOtOrg9Hh8ijkSwgYQBE81yS7vD7p-6kUoOwj9P_mD5UcYNh/exec";

const quizzes = {
  kharis: [
    { q:"When faced with chaos, what grounds you most?", s:"1 Corinthians 14:33 – For God is not a God of disorder but of peace." },
    { q:"How do you prefer to impact others?", s:"Matthew 5:16 – Let your light shine before others." },
    { q:"In a group, you are the one who...", s:"Romans 12:6 – We have different gifts, according to the grace given to each of us." },
    { q:"How do you love to serve in the Kingdom?", s:"Ephesians 6:7 – Serve wholeheartedly, as if you were serving the Lord." },
    { q:"If you could lead something, what would it be?", s:"Joshua 1:9 – Be strong and courageous." },
    { q:"When someone is hurting, what do you naturally do?", s:"2 Corinthians 1:4 – God comforts us… so we can comfort others." },
    { q:"What excites you most: creating, organising, helping, or sharing boldly?", s:"Colossians 3:23 – Whatever you do, work at it with all your heart." },
    { q:"If you had one talent to use for God, what would it be?", s:"1 Peter 4:10 – Each of you should use whatever gift you have received to serve others." }
  ]
};

const deptKeywords = {
  "Administration":["organise","plan","manage","admin","schedule"],
  "Children's Department":["children","kids","play","teach"],
  "Design":["creative","visual","art","design","draw"],
  "Drama":["act","perform","storytelling","drama"],
  "Evangelism":["share","bold","witness","evangelism","preach"],
  "Follow Up":["follow","mentor","support","guidance"],
  "Hospitality":["welcome","greet","friendly","hospitality"],
  "Host Team":["host","welcome","assist","greeter"],
  "Music":["sing","play","instrument","worship","music"],
  "Media":["camera","video","photos","media","tech"],
  "Production":["sound","lights","tech","production"],
  "Sanctuary Keepers":["clean","organise","maintain","church"],
  "Set-up":["setup","arrange","prepare","set-up"],
  "Ushers":["guide","assist","usher","welcome"],
  "Welfare":["help","serve","support","care","welfare"],
  "Social Media":["trends","post","social","online","media"],
  "Security":["protect","caring","safety","protection","love"],
  "Uniform":["order","excellence","fashion","identity","presentation"],
  "Sound":["sound","excellence","clarity","beats","amplify"],
  "Spoken Word":["poems","rhythm","truth","voice","impact"]
};

function initScores() {
  deptScores = {}; Object.keys(deptKeywords).forEach(d=>deptScores[d]=0);
  traits = {creative:0, organised:0, bold:0, servant:0};
  answersGiven = [];
}

function showQuestion() {
  const qObj = quizzes[currentQuiz][currentQ];
  quizEl.innerHTML = `
    <div class="scripture">${qObj.s}</div>
    <div class="question">${qObj.q}</div>
    <input type="text" id="answer" placeholder="Type your answer here...">
    <br>
    <button class="btn" id="nextBtn">Next</button>
  `;
  quizEl.style.display="block";
  startScreenEl.style.display="none";
  resultEl.style.display="none";
  backBtn.style.display = currentQ>0?"inline-block":"none";
  progressEl.style.width = ((currentQ+1)/quizzes[currentQuiz].length*100)+"%";

  document.getElementById("nextBtn").onclick = nextQuestion;
}

function scoreAnswer(input) {
  input = input.toLowerCase();
  if(input.includes("create")||input.includes("art")||input.includes("design")) traits.creative++;
  if(input.includes("organise")||input.includes("plan")||input.includes("arrange")) traits.organised++;
  if(input.includes("speak")||input.includes("lead")||input.includes("bold")) traits.bold++;
  if(input.includes("help")||input.includes("serve")||input.includes("care")) traits.servant++;
  Object.entries(deptKeywords).forEach(([dept, keywords])=>{
    keywords.forEach(word=>{
      if(input.includes(word)) deptScores[dept] += 2;
    });
  });
  answersGiven.push(JSON.parse(JSON.stringify({question: quizzes[currentQuiz][currentQ].q, answer: input, scripture: quizzes[currentQuiz][currentQ].s})));
}

function nextQuestion() {
  const input = document.getElementById("answer").value.trim();
  if(!input) { alert("Please type something!"); return; }
  questionHistory.push({
    q: currentQ,
    deptScores: JSON.parse(JSON.stringify(deptScores)),
    traits: JSON.parse(JSON.stringify(traits)),
    answersGiven: JSON.parse(JSON.stringify(answersGiven))
  });
  scoreAnswer(input);
  currentQ++;
  if(currentQ < quizzes[currentQuiz].length) showQuestion();
  else showResult();
}

backBtn.onclick = ()=> {
  if(questionHistory.length>0){
    const last = questionHistory.pop();
    currentQ = last.q;
    deptScores = last.deptScores;
    traits = last.traits;
    answersGiven = last.answersGiven;
    showQuestion();
  }
}

function showResult() {
  quizEl.style.display="none";
  resultEl.style.display="block";

  if(traits.creative>traits.organised) deptScores["Design"]+=2;
  if(traits.organised>traits.creative) deptScores["Administration"]+=2;
  if(traits.bold>traits.servant) deptScores["Evangelism"]+=2;
  if(traits.servant>traits.bold) deptScores["Welfare"]+=2;

  const sorted = Object.entries(deptScores).sort((a,b)=>b[1]-a[1]).slice(0,2);

  let html = `<h2>${username} (${branch}), Your Top 2 Departments:</h2>`;
  sorted.forEach(([d], i)=>{
    html += `<div class="department" id="dept-${i}"><strong>${d}</strong>
             <div class="scripture-box" id="scripture-${i}">God has gifted you uniquely to serve in ${d}.</div>
             </div>`;
  });
  html += `<button class="btn" onclick="restart()">Start Over</button>
           <button class="btn" onclick="saveResult()">💾 Save My Results</button>`;
  resultEl.innerHTML = html;

  if(typeof confetti!=="undefined") confetti({particleCount:150,spread:70,origin:{y:0.6}});

  sorted.forEach((_, i)=>{
    setTimeout(()=>{
      document.getElementById(`dept-${i}`).classList.add("show");
      setTimeout(()=>{
        document.getElementById(`scripture-${i}`).classList.add("show");
      }, 500);
    }, i*1000);
  });
}

window.nextQuestion = nextQuestion;

window.restart = function() {
  currentQ=0; questionHistory=[]; initScores();
  startScreenEl.style.display="block";
  quizEl.style.display="none";
  resultEl.style.display="none";
  backBtn.style.display="none";
  progressEl.style.width="0%";
}

window.saveResult = function(){
  const sorted = Object.entries(deptScores).sort((a,b)=>b[1]-a[1]).slice(0,2);
  const top1 = sorted[0] ? sorted[0][0] : "";
  const top2 = sorted[1] ? sorted[1][0] : "";

  const today = new Date();
  const dateString = today.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit", year: "numeric" });

  fetch(SHEET_URL, {
    method: "POST",
    body: JSON.stringify({
      fullName: username,
      branch: branch,
      topDept1: top1,
      topDept2: top2,
      date: dateString,
      answers: answersGiven
    }),
    headers: { "Content-Type": "application/json" },
    mode: "no-cors"
  })
  .then(() => alert("✅ Your results have been saved!"))
  .catch(err => {
    console.error(err);
    alert("❌ Error saving results. Check console.");
  });
}

document.getElementById("start-kharis").onclick = ()=>{
  username=(document.getElementById("username").value.trim()||"Friend");
  const branchInput = document.getElementById("branch").value.trim();
  if(!branchInput){ alert("Please enter your branch."); return; }
  branch = branchInput;
  currentQuiz="kharis"; currentQ=0; initScores(); showQuestion();
};

document.getElementById("modeBtn").onclick = ()=>{
  document.body.classList.toggle("light");
  document.getElementById("modeBtn").textContent = 
    document.body.classList.contains("light") ? "☀️" : "🌙";
};
})();
</script>
</body>
</html>
